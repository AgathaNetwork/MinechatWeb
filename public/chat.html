<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Minechat</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <style>
      [v-cloak]{display:none}
      .msg-row{width:100%}
      .msg-time{opacity:0;transition:opacity .12s ease;font-size:12px;color:#888;user-select:none;white-space:nowrap}
      .msg-row:hover .msg-time{opacity:1}
      .loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #409eff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
      @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    </style>
  </head>
  <body>
    <div id="app" v-cloak>
      <el-container style="height:100vh">
        <el-header style="display:flex;align-items:center;justify-content:space-between">
          <div style="display:flex;align-items:center;gap:16px">
            <h2 style="margin:0">会话</h2>
            <el-menu mode="horizontal" :ellipsis="false" default-active="chat" @select="onNav" style="border-bottom:none;background:transparent">
              <el-menu-item index="chat">会话</el-menu-item>
              <el-menu-item index="players">玩家</el-menu-item>
              <el-menu-item index="me">我</el-menu-item>
            </el-menu>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <el-button v-if="!isLoggedIn" size="small" type="primary" @click="openLoginPopup">使用 Microsoft 登录</el-button>
            <el-button v-else size="small" @click="logout">登出</el-button>
            <el-avatar v-if="isLoggedIn && selfFaceUrl" shape="square" :src="selfFaceUrl" :size="28" @click="onNav('me')" style="cursor:pointer"></el-avatar>
          </div>
        </el-header>

        <el-container style="min-height:0">
          <el-aside width="280px" style="border-right:1px solid #e6e6e6;background:#fff;padding:12px;overflow:auto">
            <div>
              <h3 style="margin:0 0 8px 0">全服聊天</h3>
              <div @click="openGlobal" :style="{cursor:'pointer',padding:'8px',borderRadius:'6px',background: currentChatId==='global' ? '#eef6ff' : 'transparent'}">
                <div style="display:flex;align-items:center;gap:10px">
                  <el-avatar shape="square" src="/img/Ag_0404.png" :size="40"></el-avatar>
                  <div style="font-weight:500">全服</div>
                </div>
              </div>
            </div>
            <div style="margin-top:12px">
              <h3 style="margin:0 0 8px 0">会话</h3>
              <div v-for="c in chats" :key="c.id" @click="onChatClick(c)"
                   :style="{cursor:'pointer',padding:'8px',borderRadius:'6px',marginBottom:'6px',background: currentChatId===c.id ? '#eef6ff' : 'transparent',position:'relative'}">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
                  <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0">
                    <el-avatar v-if="getChatAvatar(c)" shape="square" :src="getChatAvatar(c)" :size="40"></el-avatar>
                    <el-avatar v-else shape="square" :size="40">{{ getChatInitial(c) }}</el-avatar>
                    <div style="flex:1;min-width:0">
                      <div style="font-weight:500;margin-bottom:4px">{{ getChatName(c) }}</div>
                      <div style="font-size:12px;color:#999;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ formatLastMessage(c) }}</div>
                    </div>
                  </div>
                  <div v-if="hasUnread(c.id)" style="width:8px;height:8px;border-radius:50%;background:#1890ff;flex-shrink:0"></div>
                </div>
              </div>
            </div>
          </el-aside>

          <el-main style="padding:12px;display:flex;flex-direction:column;min-height:0;height:100%">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div style="display:flex;align-items:center;gap:8px">
                <el-avatar v-if="currentChatFaceUrl" shape="square" :src="currentChatFaceUrl" :size="32"></el-avatar>
                <h3 style="margin:0">{{ currentChatTitle }}</h3>
              </div>
              <div></div>
            </div>

            <div style="flex:1;min-height:0;margin-top:12px;position:relative">
              <div v-if="chatLoading" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.95);display:flex;align-items:center;justify-content:center;z-index:1000;border-radius:8px">
                <div style="text-align:center">
                  <div class="loading-spinner"></div>
                  <div style="margin-top:12px;color:#666;font-size:14px">加载中...</div>
                </div>
              </div>
              <div ref="messagesEl" @scroll="onMessagesScroll" style="width:100%;height:100%;padding:12px;overflow:auto;background:#fff;border:1px solid #eee;border-radius:8px">
                <div v-if="loadingMore" style="display:flex;justify-content:center;padding:6px 0">
                  <div class="loading-spinner" style="width:22px;height:22px;border-width:3px"></div>
                </div>
                <div v-for="m in messages" :key="m.id" class="msg-wrapper msg-row" :data-id="m.id"
                   :style="{ display:'flex', justifyContent: isOwnMessage(m) ? 'flex-end' : 'flex-start', marginBottom:'10px', gap: '8px' }">
                <el-avatar v-if="!isOwnMessage(m) && messageAuthorFaceUrl(m)" shape="square" :src="messageAuthorFaceUrl(m)" :size="36" style="flex-shrink:0"></el-avatar>
                <div :style="{ maxWidth:'80%', display:'flex', flexDirection:'column', alignItems: isOwnMessage(m) ? 'flex-end' : 'flex-start' }">
                  <div style="font-size:12px;color:#888;margin:0 6px 4px 6px">{{ messageAuthorName(m) }}</div>

                  <div v-if="!isGlobalChat && m.replied_to && repliedRefMessage(m)" class="reply-quote"
                       style="padding:6px 8px;border-left:3px solid #ccc;background:#f7f7f7;margin:0 0 6px 0;border-radius:6px;width:100%">
                    <span style="cursor:pointer" @click="scrollToMessage((typeof m.replied_to==='object') ? (m.replied_to.id||'') : m.replied_to)">
                      {{ messageAuthorName(repliedRefMessage(m)) }}: {{ messageTextPreview(repliedRefMessage(m)) || '[已回复]' }}
                    </span>
                  </div>

                  <div style="display:flex;align-items:flex-end;gap:6px">
                    <span v-if="isOwnMessage(m)" class="msg-time">{{ formatTime(m) }}</span>
                    <div @contextmenu.prevent="onMessageContextMenu($event, m)"
                         :style="{ padding:'8px 10px', borderRadius:'12px', border:'1px solid #eee', background: bubbleBackground(m), width:'fit-content', maxWidth:'100%' }">
                      <template v-if="m.type==='emoji' && m.content && m.content.url">
                        <img :src="m.content.url" alt="emoji" style="max-height:96px;display:inline-block;vertical-align:middle" />
                      </template>
                      <template v-else-if="m.type==='file' && m.content && isImageFile(m)">
                        <img :src="fileDisplayUrl(m)" :alt="m.content.filename || 'image'" style="max-width:320px;max-height:240px;display:block;border-radius:8px" />
                        <div v-if="m.content.filename" style="margin-top:6px;font-size:12px;color:#666">{{ m.content.filename }}</div>
                      </template>
                      <template v-else-if="m.type==='file' && m.content && isVideoFile(m)">
                        <video :src="fileDisplayUrl(m)" controls style="max-width:320px;max-height:240px;display:block;border-radius:8px" :poster="m.content.thumbnailUrl || ''"></video>
                        <div v-if="m.content.filename" style="margin-top:6px;font-size:12px;color:#666">{{ m.content.filename }}</div>
                      </template>
                      <template v-else-if="m.type==='file' && m.content && m.content.url">
                        <a :href="m.content.url" target="_blank" rel="noopener" style="color:#0366d6;text-decoration:none">
                          {{ m.content.filename || '下载文件' }}
                        </a>
                      </template>
                      <template v-else>
                        <span style="white-space:pre-wrap;word-break:break-word">{{ messageTextPreview(m) }}</span>
                      </template>
                    </div>
                    <span v-if="!isOwnMessage(m)" class="msg-time">{{ formatTime(m) }}</span>
                  </div>
                </div>
              </div>
            </div>
            </div>

            <div v-if="ctxMenuVisible" @click.stop style="position:fixed;z-index:9999;background:#fff;border:1px solid #dcdfe6;border-radius:6px;padding:6px;min-width:120px"
                 :style="{ left: ctxMenuX + 'px', top: ctxMenuY + 'px' }">
              <div style="cursor:pointer;padding:6px 10px" @click="ctxReply">回复</div>
              <div v-if="canCollectEmoji(ctxMenuMsg)" style="cursor:pointer;padding:6px 10px" @click="ctxCollectEmoji">添加到表情包</div>
            </div>

            <div v-if="replyTarget" style="margin-top:10px;padding:8px;border-left:3px solid #ccc;background:#f7f7f7;border-radius:6px">
              <small>回复: {{ replyPreview }}</small>
              <el-button size="small" style="margin-left:8px" @click="clearReplyTarget">取消</el-button>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;align-items:center;position:relative;flex-shrink:0">
              <input ref="fileInputEl" type="file" accept="image/*,video/*" style="display:none" @change="onFileSelected" />
              <div v-if="!isGlobalChat" style="display:flex;gap:2px;align-items:center;flex-shrink:0">
                <el-button type="default" @click.stop="openFilePicker" circle>
                  <el-icon><folder-opened /></el-icon>
                </el-button>
                <el-button type="default" @click.stop="toggleEmojiPanel" circle>
                  <el-icon><magic-stick /></el-icon>
                </el-button>
              </div>
              <el-input v-model="msgInput" placeholder="输入消息" @keyup.enter="sendText"></el-input>
              <el-button type="primary" @click="sendText">发送</el-button>

              <div v-if="emojiPanelVisible" @click.stop style="position:absolute;left:0;bottom:46px;width:320px;max-height:320px;overflow:auto;background:#fff;border:1px solid #ddd;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08);border-radius:8px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                  <strong>我的表情包</strong>
                  <el-button size="small" @click="goEmojiManage">管理</el-button>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px">
                  <button v-for="p in emojiPacks" :key="p.id" @click="sendEmoji(p)" style="border:none;background:transparent;padding:4px;cursor:pointer">
                    <img :src="p.url" alt="emoji" style="width:48px;height:48px;object-fit:contain" />
                  </button>
                </div>
              </div>
            </div>
          </el-main>
        </el-container>
      </el-container>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2/dist/index.iife.min.js"></script>
    <script src="/api/socket.io/socket.io.js"></script>
    <script src="/chat.js"></script>
  </body>
</html>
