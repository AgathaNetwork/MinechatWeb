<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/theme.js"></script>
    <title>大地图 - Minechat</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-plus/theme-chalk/dark/css-vars.css" />
    <style>
      [v-cloak]{display:none}
      html, body { height: 100%; margin: 0; overflow: hidden; background: var(--mc-body-bg); }
      .frame-wrap {
        width: 100%;
        height: 100%;
        background: var(--mc-surface);
        border: 1px solid var(--mc-border);
        border-radius: 12px;
        overflow: hidden;
      }
      iframe { width: 100%; height: 100%; border: 0; display: block; }
    </style>
  </head>
  <body>
    <div id="app" v-cloak>
      <el-container style="height:100vh">
        <el-header style="display:flex;align-items:center;justify-content:space-between">
          <div style="display:flex;align-items:center;gap:16px">
            <div style="display:flex;align-items:center;gap:6px">
              <h2 style="margin:0">大地图</h2>
              <el-button @click="openShare" circle size="small" title="分享">
                <el-icon><share /></el-icon>
              </el-button>
            </div>
            <el-menu mode="horizontal" :ellipsis="false" default-active="" @select="onNav" style="border-bottom:none;background:transparent">
              <el-menu-item index="chat">会话</el-menu-item>
              <el-menu-item index="players">玩家</el-menu-item>
              <el-menu-item index="gallery">相册</el-menu-item>
              <el-menu-item index="me">工作台</el-menu-item>
            </el-menu>
          </div>
          <div style="display:flex;align-items:center;gap:8px"></div>
        </el-header>
        <el-main style="padding:12px">
          <div class="frame-wrap">
            <iframe ref="mapFrame" :src="frameSrc" referrerpolicy="no-referrer-when-downgrade" allowfullscreen></iframe>
          </div>
        </el-main>
      </el-container>

      <el-dialog v-model="shareDialogVisible" title="分享坐标" width="520px" :close-on-click-modal="false">
        <div style="display:flex;flex-direction:column;gap:10px">
          <el-input v-model="shareForm.name" placeholder="名称（例如：下界门）" maxlength="50" show-word-limit></el-input>
          <el-input v-model="shareForm.description" type="textarea" :rows="3" placeholder="描述（可选）" maxlength="200" show-word-limit></el-input>
          <el-select v-model="shareChatId" filterable placeholder="选择会话" style="width:100%" :loading="shareChatsLoading">
            <el-option v-for="c in shareChatOptions" :key="c.value" :label="c.label" :value="c.value" />
          </el-select>
          <div v-if="shareError" style="font-size:12px;color:var(--el-color-danger)">{{ shareError }}</div>
        </div>
        <template #footer>
          <el-button @click="shareDialogVisible=false">取消</el-button>
          <el-button type="primary" :loading="shareSending" :disabled="!shareChatId" @click="confirmShare">发送</el-button>
        </template>
      </el-dialog>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2/dist/index.iife.min.js"></script>
    <script>
      const { createApp } = Vue;

      const app = createApp({
        data() {
          return {
            frameSrc: 'https://map.agatha.org.cn/',

            apiBase: '',
            token: (localStorage.getItem('token') || '').trim(),

            shareDialogVisible: false,
            shareChatsLoading: false,
            shareChatOptions: [],
            shareChatId: '',
            shareSending: false,
            shareError: '',
            shareForm: { name: '', description: '' },
          };
        },
        created() {
          this.frameSrc = this.computeFrameSrc();
        },
        methods: {
          async fetchConfig() {
            const conf = await fetch('/config', { credentials: 'include' }).then((r) => r.json());
            this.apiBase = (conf && (conf.apiProxyBase || conf.apiBase)) ? (conf.apiProxyBase || conf.apiBase) : '';
            return conf;
          },
          authHeaders(extra) {
            const h = Object.assign({}, extra || {});
            const t = (this.token || '').trim();
            if (t) h['Authorization'] = `Bearer ${t}`;
            return h;
          },
          async safeFetch(url, options) {
            const opt = Object.assign({ credentials: 'include' }, options || {});
            opt.headers = this.authHeaders(opt.headers);
            return fetch(url, opt);
          },
          computeFrameSrc() {
            try {
              const sp = new URLSearchParams(window.location.search || '');
              const rawHash = String(sp.get('hash') || '').trim();
              if (rawHash) return 'https://map.agatha.org.cn/#' + rawHash.replace(/^#/, '');

              const world = String(sp.get('world') || '').trim();
              if (!world) return 'https://map.agatha.org.cn/';
              const x = Number(sp.get('x'));
              const y = Number(sp.get('y'));
              const z = Number(sp.get('z'));
              if (!Number.isFinite(x) || !Number.isFinite(z)) return 'https://map.agatha.org.cn/';
              const yy = Number.isFinite(y) ? y : 0;
              const hash =
                encodeURIComponent(world) +
                ':' +
                encodeURIComponent(Math.round(x)) +
                ':' +
                encodeURIComponent(Math.round(yy)) +
                ':' +
                encodeURIComponent(Math.round(z)) +
                ':1500:0:0:0:0:perspective';
              return 'https://map.agatha.org.cn/#' + hash;
            } catch (e) {
              return 'https://map.agatha.org.cn/';
            }
          },
          extractHashFromAnyUrl(urlLike) {
            try {
              const s = String(urlLike || '').trim();
              if (!s) return '';
              const idx = s.indexOf('#');
              if (idx < 0) return '';
              return s.slice(idx + 1);
            } catch (e) {
              return '';
            }
          },
          tryGetIframeUrl() {
            // Cross-origin: contentWindow.location is usually not accessible.
            // Best-effort: use iframe.src attribute as a fallback.
            try {
              const el = this.$refs && this.$refs.mapFrame ? this.$refs.mapFrame : null;
              if (!el) return '';
              try {
                // may throw on cross-origin
                const href = el.contentWindow && el.contentWindow.location ? String(el.contentWindow.location.href || '') : '';
                if (href) return href;
              } catch (e) {}
              try {
                const src = String(el.src || '');
                return src;
              } catch (e2) {
                return '';
              }
            } catch (e3) {
              return '';
            }
          },
          parseCoordsFromCurrentUrl() {
            // 1) Prefer extracting from iframe URL/hash (supports switching world URL format)
            try {
              const iframeUrl = this.tryGetIframeUrl();
              const iframeHash = this.extractHashFromAnyUrl(iframeUrl);
              const h = iframeHash ? iframeHash.replace(/^#/, '') : '';
              if (h) {
                const parts = h.split(':');
                if (parts && parts.length >= 4) {
                  const dimension = decodeURIComponent(parts[0] || '');
                  const x = Number(decodeURIComponent(parts[1] || ''));
                  const y = Number(decodeURIComponent(parts[2] || ''));
                  const z = Number(decodeURIComponent(parts[3] || ''));
                  if (dimension && Number.isFinite(x) && Number.isFinite(z)) {
                    return { dimension, x: Math.round(x), y: Number.isFinite(y) ? Math.round(y) : 0, z: Math.round(z) };
                  }
                }
              }
            } catch (e) {}

            // 2) Fallback: wrapper page query params
            try {
              const sp = new URLSearchParams(window.location.search || '');
              const world = String(sp.get('world') || '').trim();
              const x = Number(sp.get('x'));
              const y = Number(sp.get('y'));
              const z = Number(sp.get('z'));
              if (world && Number.isFinite(x) && Number.isFinite(z)) {
                return { dimension: world, x: Math.round(x), y: Number.isFinite(y) ? Math.round(y) : 0, z: Math.round(z) };
              }
            } catch (e) {}

            // 3) Fallback: explicit hash param
            try {
              const sp = new URLSearchParams(window.location.search || '');
              const rawHash = String(sp.get('hash') || '').trim();
              const h = rawHash ? rawHash.replace(/^#/, '') : '';
              if (!h) return null;
              const parts = h.split(':');
              if (!parts || parts.length < 4) return null;
              const dimension = decodeURIComponent(parts[0] || '');
              const x = Number(decodeURIComponent(parts[1] || ''));
              const y = Number(decodeURIComponent(parts[2] || ''));
              const z = Number(decodeURIComponent(parts[3] || ''));
              if (!dimension || !Number.isFinite(x) || !Number.isFinite(z)) return null;
              return { dimension, x: Math.round(x), y: Number.isFinite(y) ? Math.round(y) : 0, z: Math.round(z) };
            } catch (e) {
              return null;
            }
          },
          async loadShareChats() {
            if (this.shareChatsLoading) return;
            this.shareChatsLoading = true;
            this.shareError = '';
            try {
              if (!this.apiBase) await this.fetchConfig();
              if (!this.apiBase) throw new Error('缺少 API 配置');
              const res = await this.safeFetch(`${this.apiBase}/chats`);
              if (!res.ok) throw new Error('加载会话失败');
              const list = await res.json().catch(() => []);
              const arr = Array.isArray(list) ? list : [];
              this.shareChatOptions = arr
                .filter((c) => c && String(c.id || '').trim() && String(c.id) !== 'global')
                .map((c) => ({ value: String(c.id), label: String(c.displayName || c.name || c.id) }));
            } catch (e) {
              this.shareError = (e && e.message) ? e.message : String(e);
              this.shareChatOptions = [];
            } finally {
              this.shareChatsLoading = false;
            }
          },
          async openShare() {
            this.shareError = '';
            const coords = this.parseCoordsFromCurrentUrl();
            if (!coords) {
              try { ElementPlus.ElMessage.warning('当前页面没有可分享的坐标参数'); } catch (e0) {}
              return;
            }
            this.shareDialogVisible = true;
            await this.loadShareChats();
          },
          async confirmShare() {
            if (this.shareSending) return;
            try {
              this.shareError = '';
              const coords = this.parseCoordsFromCurrentUrl();
              if (!coords) {
                this.shareError = '当前页面没有可分享的坐标参数';
                return;
              }
              const name = String(this.shareForm.name || '').trim();
              const descriptionRaw = String(this.shareForm.description || '').trim();
              const description = descriptionRaw ? descriptionRaw : null;
              const chatId = String(this.shareChatId || '').trim();
              if (!chatId) {
                this.shareError = '请选择会话';
                return;
              }
              if (!name) {
                this.shareError = '请输入名称';
                return;
              }

              this.shareSending = true;
              if (!this.apiBase) await this.fetchConfig();
              if (!this.apiBase) throw new Error('缺少 API 配置');
              const payload = {
                type: 'coordinate',
                content: {
                  name,
                  dimension: coords.dimension,
                  x: coords.x,
                  y: coords.y,
                  z: coords.z,
                  description,
                },
              };
              const res = await this.safeFetch(`${this.apiBase}/chats/${encodeURIComponent(chatId)}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });
              if (!res.ok) {
                const txt = await res.text().catch(() => '');
                throw new Error(txt || '发送失败');
              }
              this.shareDialogVisible = false;
              this.shareChatId = '';
              this.shareForm.name = '';
              this.shareForm.description = '';
              try { ElementPlus.ElMessage.success('已发送'); } catch (e2) {}
            } catch (e) {
              this.shareError = (e && e.message) ? e.message : String(e);
            } finally {
              this.shareSending = false;
            }
          },
          onNav(key) {
            if (key === 'chat') window.location.href = '/chat.html';
            else if (key === 'gallery') window.location.href = '/gallery.html';
            else if (key === 'players') window.location.href = '/players.html';
            else if (key === 'me') window.location.href = '/me.html';
          },
        },
      });

      try {
        const icons = window.ElementPlusIconsVue;
        if (icons && typeof icons === 'object') {
          for (const [key, component] of Object.entries(icons)) {
            app.component(key, component);
          }
        }
      } catch (e) {}

      app.use(ElementPlus).mount('#app');
    </script>
  </body>
</html>
