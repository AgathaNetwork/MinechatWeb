<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <script src="/theme.js"></script>
    <title>材料列表管理 - Minechat</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="/vendor/element-plus/index.css" />
    <link rel="stylesheet" href="/vendor/element-plus/theme-chalk/dark/css-vars.css" />
    <style>
      [v-cloak]{display:none}
      html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-text-size-adjust:100%}
      body{margin:0;padding:0;background:#f5f5f5}
      input,textarea,.el-input__inner,.el-textarea__inner{font-size:16px !important}
      .el-select .el-select__selected-item,.el-select .el-select__placeholder{font-size:16px !important}
      .top-spacer{position:fixed;top:0;left:0;right:0;height:4vh;background:var(--mc-body-bg);z-index:99}
      .top-bar{position:fixed;top:4vh;left:0;right:0;height:50px;background:#fff;border-bottom:1px solid #e6e6e6;display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:100}
      .content-area{position:fixed;top:calc(4vh + 50px);left:0;right:0;bottom:56px;overflow:auto;padding:12px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
      .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:56px;background:#fff;border-top:1px solid #e6e6e6;display:flex;justify-content:space-around;align-items:center;z-index:100}
      .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;color:#666;font-size:12px;padding:4px;text-decoration:none}
      .nav-item.active{color:#409eff}
      .item{padding:12px;border-bottom:1px solid var(--mc-border)}
      .actions{display:flex;gap:6px;margin-top:10px;flex-wrap:nowrap}
      .actions .el-button{flex:1 1 0;min-width:0;padding-left:0;padding-right:0}
    </style>
  </head>
  <body>
    <div class="top-spacer"></div>
    <div id="app" v-cloak>
      <div class="top-bar">
        <div style="display:flex;align-items:center;gap:8px">
          <el-button @click="goBack" circle size="small">
            <el-icon><arrow-left /></el-icon>
          </el-button>
          <h3 style="margin:0">材料列表</h3>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <el-avatar v-if="selfFaceUrl" shape="square" :src="selfFaceUrl" :size="32"></el-avatar>
        </div>
      </div>

      <div class="content-area">
        <el-alert v-if="!isLoggedIn" type="warning" :closable="false" show-icon title="需要登录后才能管理材料列表"></el-alert>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <el-button size="small" plain :loading="loading" :disabled="!isLoggedIn" @click="reload">刷新</el-button>
          <el-button size="small" type="primary" plain :disabled="!isLoggedIn" @click="openCreate">新建</el-button>
          <span style="font-size:12px;color:#888" v-if="loading">加载中…</span>
          <span style="font-size:12px;color:#888" v-else-if="items.length">共 {{ items.length }} 条</span>
        </div>

        <div style="margin-top:12px" v-if="loadError">
          <el-alert type="error" :closable="false" show-icon title="加载失败"></el-alert>
          <div style="margin-top:8px;font-size:12px;color:#666;word-break:break-all">{{ loadError }}</div>
        </div>

        <el-card v-if="isLoggedIn" style="margin-top:12px">
          <div v-if="!items.length && !loading" style="font-size:12px;color:#888;padding:6px 0">暂无材料列表</div>
          <div v-for="it in items" :key="it.id" class="item">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
              <div style="flex:1;min-width:0">
                <div style="font-weight:600;line-height:1.4">{{ it.name }}</div>
                <div style="margin-top:6px;color:#666;font-size:13px;line-height:1.4">{{ it.description }}</div>
                <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                  <el-tag size="small" :type="it.done ? 'success' : 'warning'">{{ it.done ? '已完成' : '未完成' }}</el-tag>
                  <span style="font-size:12px;color:#888">上传：{{ formatTs(it.upload_time) }}</span>
                  <span style="font-size:12px;color:#888" v-if="it.done_time">完成：{{ formatTs(it.done_time) }}</span>
                </div>
              </div>
            </div>

            <div class="actions">
              <el-button size="small" plain @click="openDetail(it)">详情</el-button>
              <el-button size="small" plain @click="openEdit(it)">编辑</el-button>
              <el-button size="small" :type="it.done ? 'info' : 'success'" plain :disabled="!!it.done" @click="markDone(it)">{{ it.done ? '已完成' : '完成' }}</el-button>
              <el-button size="small" type="danger" plain @click="removeItem(it)">删除</el-button>
            </div>
          </div>
        </el-card>
      </div>

      <div class="bottom-nav">
        <a href="/m/chats.html" class="nav-item">
          <el-icon :size="20"><chat-dot-round /></el-icon>
          <span>会话</span>
        </a>
        <a href="/m/players.html" class="nav-item">
          <el-icon :size="20"><user /></el-icon>
          <span>玩家</span>
        </a>
        <a href="/m/me.html" class="nav-item active">
          <el-icon :size="20"><tickets /></el-icon>
          <span>工作台</span>
        </a>
      </div>

      <el-dialog v-model="createVisible" title="新建材料列表" width="92%" top="10vh">
        <div
          @dragover.prevent="csvDragging=true"
          @dragleave.prevent="csvDragging=false"
          @drop.prevent="onCsvDrop"
          @click="openCsvPicker"
          :style="{
            border: '2px dashed var(--el-color-primary)',
            borderRadius: '10px',
            padding: '14px',
            cursor: 'pointer',
            marginBottom: '12px',
            background: csvDragging ? 'var(--el-color-primary-light-9)' : 'var(--el-fill-color-lighter)',
            color: 'var(--el-text-color-regular)'
          }"
        >
          <div style="font-weight:600">选择/导入 CSV</div>
          <div style="margin-top:6px;font-size:12px;color:var(--el-text-color-secondary)">点击选择 CSV，解析后会自动填充材料清单</div>
          <div style="margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <el-tag v-if="csvFileName" size="small" type="info" effect="plain">{{ csvFileName }}</el-tag>
            <el-tag v-if="csvParsing" size="small" type="warning" effect="plain">解析中…</el-tag>
          </div>
          <div v-if="csvError" style="margin-top:10px">
            <el-alert type="error" :closable="false" show-icon title="CSV 解析失败"></el-alert>
            <div style="margin-top:8px;font-size:12px;color:#666;word-break:break-all">{{ csvError }}</div>
          </div>
          <input ref="csvInputRef" type="file" accept=".csv" style="display:none" @change="onCsvInputChange" />
        </div>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:0 0 12px 0">
          <span style="font-size:12px;color:var(--el-text-color-secondary)">文件编码</span>
          <el-select v-model="csvEncoding" size="small" style="width:160px" :disabled="csvParsing">
            <el-option label="自动检测" value="auto"></el-option>
            <el-option label="UTF-8" value="UTF-8"></el-option>
            <el-option label="GBK" value="GBK"></el-option>
            <el-option label="GB2312" value="GB2312"></el-option>
            <el-option label="Big5" value="Big5"></el-option>
          </el-select>
          <el-button size="small" plain :disabled="!csvHasFile || csvParsing" @click="reparseCsv">重新解析</el-button>
        </div>

        <el-form label-width="80px">
          <el-form-item label="标题">
            <el-input v-model="createForm.name" placeholder="请输入标题" maxlength="120" show-word-limit></el-input>
          </el-form-item>
          <el-form-item label="描述">
            <el-input v-model="createForm.description" type="textarea" :rows="3" placeholder="请输入描述" maxlength="500" show-word-limit></el-input>
          </el-form-item>
        </el-form>

        <div style="display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px 0;gap:10px;flex-wrap:wrap">
          <div style="font-weight:600">材料清单</div>
          <el-button size="small" plain @click="addCreateRow">添加一行</el-button>
        </div>

        <el-table :data="createForm.items" size="small" style="width:100%" empty-text="请添加材料项">
          <el-table-column label="名称" min-width="200">
            <template #default="scope">
              <el-input v-model="scope.row.name" placeholder="材料名称" size="small"></el-input>
            </template>
          </el-table-column>
          <el-table-column label="数量" width="120">
            <template #default="scope">
              <el-input-number v-model="scope.row.count" :min="1" :max="999999" size="small"></el-input-number>
            </template>
          </el-table-column>
          <el-table-column label="操作" width="86">
            <template #default="scope">
              <el-button size="small" type="danger" plain @click="removeCreateRow(scope.$index)">移除</el-button>
            </template>
          </el-table-column>
        </el-table>

        <template #footer>
          <div style="display:flex;justify-content:flex-end;gap:10px">
            <el-button @click="createVisible=false">取消</el-button>
            <el-button type="primary" :loading="creating" @click="submitCreate">创建</el-button>
          </div>
        </template>
      </el-dialog>

      <el-dialog v-model="editVisible" title="编辑材料列表" width="92%" top="10vh">
        <el-form label-width="80px">
          <el-form-item label="标题">
            <el-input v-model="editForm.name" placeholder="请输入标题" maxlength="120" show-word-limit></el-input>
          </el-form-item>
          <el-form-item label="描述">
            <el-input v-model="editForm.description" type="textarea" :rows="3" placeholder="请输入描述" maxlength="500" show-word-limit></el-input>
          </el-form-item>
        </el-form>

        <template #footer>
          <div style="display:flex;justify-content:flex-end;gap:10px">
            <el-button @click="editVisible=false">取消</el-button>
            <el-button type="primary" :loading="editing" @click="submitEdit">保存</el-button>
          </div>
        </template>
      </el-dialog>

      <el-dialog v-model="detailVisible" title="材料列表详情" width="92%" top="10vh">
        <el-skeleton :loading="detailLoading" animated>
          <template #template>
            <el-skeleton-item variant="text" style="width:40%"></el-skeleton-item>
            <el-skeleton-item variant="text" style="width:70%;margin-top:10px"></el-skeleton-item>
            <el-skeleton-item variant="rect" style="width:100%;height:180px;margin-top:12px"></el-skeleton-item>
          </template>
          <template #default>
            <div v-if="detailError" style="margin-bottom:10px">
              <el-alert type="error" :closable="false" show-icon title="加载详情失败"></el-alert>
              <div style="margin-top:8px;font-size:12px;color:#666;word-break:break-all">{{ detailError }}</div>
            </div>

            <div v-if="detailData">
              <div style="font-size:16px;font-weight:600">{{ detailData.name }}</div>
              <div style="margin-top:6px;color:#666">{{ detailData.description }}</div>
              <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <el-tag size="small" :type="detailData.done ? 'success' : 'warning'">{{ detailData.done ? '已完成' : '未完成' }}</el-tag>
                <span style="font-size:12px;color:#888">上传：{{ formatTs(detailData.upload_time) }}</span>
                <span style="font-size:12px;color:#888" v-if="detailData.done_time">完成：{{ formatTs(detailData.done_time) }}</span>
              </div>
            </div>

            <div style="margin-top:12px">
              <div style="font-weight:600;margin-bottom:8px">材料清单</div>
              <el-table :data="detailItems" size="small" style="width:100%" empty-text="无材料项">
                <el-table-column prop="name" label="名称" min-width="160"></el-table-column>
                <el-table-column prop="count" label="数量" width="90"></el-table-column>
                <el-table-column prop="occupied" label="占用" min-width="110">
                  <template #default="scope">
                    <span>{{ scope.row.occupied || '-' }}</span>
                  </template>
                </el-table-column>
                <el-table-column label="状态" width="80">
                  <template #default="scope">
                    <el-tag size="small" :type="scope.row.done ? 'success' : 'info'">{{ scope.row.done ? '完成' : '未完成' }}</el-tag>
                  </template>
                </el-table-column>
              </el-table>
            </div>
          </template>
        </el-skeleton>

        <template #footer>
          <div style="display:flex;justify-content:flex-end">
            <el-button @click="detailVisible=false">关闭</el-button>
          </div>
        </template>
      </el-dialog>
    </div>

    <script src="/vendor/vue/vue.global.prod.js"></script>
    <script src="/vendor/element-plus/index.full.js"></script>
    <script src="/vendor/element-plus-icons/icons-vue.iife.min.js"></script>
    <script src="/m/materials.js"></script>
    <script>
      document.addEventListener('gesturestart', function (e) { e.preventDefault(); }, { passive: false });
      document.addEventListener('gesturechange', function (e) { e.preventDefault(); }, { passive: false });
      document.addEventListener('gestureend', function (e) { e.preventDefault(); }, { passive: false });
    </script>
  </body>
</html>
