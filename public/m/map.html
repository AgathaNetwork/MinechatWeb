<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <script src="/theme.js"></script>
    <title>大地图 - Minechat</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-plus/theme-chalk/dark/css-vars.css" />
    <style>
      [v-cloak]{display:none}
      html, body { height: 100%; margin: 0; overflow: hidden; background: var(--mc-body-bg); -webkit-text-size-adjust: 100%; }
      .top-spacer{position:fixed;top:0;left:0;right:0;height:4vh;background:var(--mc-body-bg);z-index:99}
      .top-bar{position:fixed;top:4vh;left:0;right:0;height:50px;background:#fff;border-bottom:1px solid #e6e6e6;display:flex;align-items:center;padding:0 12px;z-index:100;gap:0}
      .content {
        position: fixed;
        top: calc(4vh + 50px);
        left: 0;
        right: 0;
        bottom: 0;
        padding: 10px;
        box-sizing: border-box;
      }
      .frame-wrap {
        width: 100%;
        height: 100%;
        background: var(--mc-surface);
        border: 1px solid var(--mc-border);
        border-radius: 12px;
        overflow: hidden;
      }
      iframe { width: 100%; height: 100%; border: 0; display: block; }
    </style>
  </head>
  <body>
    <div class="top-spacer"></div>
    <div id="app" v-cloak>
      <div class="top-bar">
        <el-button @click="goBack" circle size="small">
          <el-icon><arrow-left /></el-icon>
        </el-button>
        <el-button @click="openShare" circle size="small" title="分享" style="margin-left:4px">
          <el-icon><share /></el-icon>
        </el-button>
        <h3 style="margin:0;flex:1;margin-left:14px">大地图</h3>
      </div>

      <div class="content">
        <div class="frame-wrap">
          <iframe ref="mapFrame" :src="frameSrc" referrerpolicy="no-referrer-when-downgrade" allowfullscreen></iframe>
        </div>
      </div>

      <el-dialog v-model="shareDialogVisible" title="分享坐标" width="92%" top="12vh" :close-on-click-modal="false">
        <div style="display:flex;flex-direction:column;gap:10px">
          <el-input v-model="shareForm.name" placeholder="名称（例如：下界门）" maxlength="50" show-word-limit></el-input>
          <el-input v-model="shareForm.description" type="textarea" :rows="3" placeholder="描述（可选）" maxlength="200" show-word-limit></el-input>
          <el-select v-model="shareChatId" filterable placeholder="选择会话" style="width:100%" :loading="shareChatsLoading">
            <el-option v-for="c in shareChatOptions" :key="c.value" :label="c.label" :value="c.value" />
          </el-select>
          <div v-if="shareError" style="font-size:12px;color:var(--el-color-danger)">{{ shareError }}</div>
        </div>
        <template #footer>
          <el-button @click="shareDialogVisible=false">取消</el-button>
          <el-button type="primary" :loading="shareSending" :disabled="!shareChatId" @click="confirmShare">发送</el-button>
        </template>
      </el-dialog>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2/dist/index.iife.min.js"></script>
    <script>
      const { createApp } = Vue;

      const app = createApp({
        data() {
          return {
            frameSrc: 'https://map.agatha.org.cn/',

            apiBase: '',
            token: (localStorage.getItem('token') || '').trim(),

            shareDialogVisible: false,
            shareChatsLoading: false,
            shareChatOptions: [],
            shareChatId: '',
            shareSending: false,
            shareError: '',
            shareForm: {
              name: '',
              description: '',
            },
          };
        },
        created() {
          this.frameSrc = this.computeFrameSrc();
        },
        methods: {
          async fetchConfig() {
            const conf = await fetch('/config', { credentials: 'include' }).then((r) => r.json());
            this.apiBase = (conf && (conf.apiProxyBase || conf.apiBase)) ? (conf.apiProxyBase || conf.apiBase) : '';
            return conf;
          },
          authHeaders(extra) {
            const h = Object.assign({}, extra || {});
            const t = (this.token || '').trim();
            if (t) h['Authorization'] = `Bearer ${t}`;
            return h;
          },
          async safeFetch(url, options) {
            const opt = Object.assign({ credentials: 'include' }, options || {});
            opt.headers = this.authHeaders(opt.headers);
            return fetch(url, opt);
          },
          computeFrameSrc() {
            try {
              const sp = new URLSearchParams(window.location.search || '');
              const rawHash = String(sp.get('hash') || '').trim();
              if (rawHash) return 'https://map.agatha.org.cn/#' + rawHash.replace(/^#/, '');

              const world = String(sp.get('world') || '').trim();
              if (!world) return 'https://map.agatha.org.cn/';
              const x = Number(sp.get('x'));
              const y = Number(sp.get('y'));
              const z = Number(sp.get('z'));
              if (!Number.isFinite(x) || !Number.isFinite(z)) return 'https://map.agatha.org.cn/';
              const yy = Number.isFinite(y) ? y : 0;

              const hash =
                encodeURIComponent(world) +
                ':' +
                encodeURIComponent(Math.round(x)) +
                ':' +
                encodeURIComponent(Math.round(yy)) +
                ':' +
                encodeURIComponent(Math.round(z)) +
                ':1500:0:0:0:0:perspective';

              return 'https://map.agatha.org.cn/#' + hash;
            } catch (e) {
              return 'https://map.agatha.org.cn/';
            }
          },
          extractHashFromAnyUrl(urlLike) {
            try {
              const s = String(urlLike || '').trim();
              if (!s) return '';
              const idx = s.indexOf('#');
              if (idx < 0) return '';
              return s.slice(idx + 1);
            } catch (e) {
              return '';
            }
          },
          tryGetIframeUrl() {
            try {
              const el = this.$refs && this.$refs.mapFrame ? this.$refs.mapFrame : null;
              if (!el) return '';
              try {
                const href = el.contentWindow && el.contentWindow.location ? String(el.contentWindow.location.href || '') : '';
                if (href) return href;
              } catch (e) {}
              try {
                return String(el.src || '');
              } catch (e2) {
                return '';
              }
            } catch (e3) {
              return '';
            }
          },
          parseCoordsFromCurrentUrl() {
            // 1) Prefer extracting from iframe URL/hash (supports switching world URL format)
            try {
              const iframeUrl = this.tryGetIframeUrl();
              const iframeHash = this.extractHashFromAnyUrl(iframeUrl);
              const h = iframeHash ? iframeHash.replace(/^#/, '') : '';
              if (h) {
                const parts = h.split(':');
                if (parts && parts.length >= 4) {
                  const dimension = decodeURIComponent(parts[0] || '');
                  const x = Number(decodeURIComponent(parts[1] || ''));
                  const y = Number(decodeURIComponent(parts[2] || ''));
                  const z = Number(decodeURIComponent(parts[3] || ''));
                  if (dimension && Number.isFinite(x) && Number.isFinite(z)) {
                    return {
                      dimension,
                      x: Math.round(x),
                      y: Number.isFinite(y) ? Math.round(y) : 0,
                      z: Math.round(z),
                    };
                  }
                }
              }
            } catch (e) {}

            // 2) Fallback: wrapper page query params
            try {
              const sp = new URLSearchParams(window.location.search || '');
              const world = String(sp.get('world') || '').trim();
              const x = Number(sp.get('x'));
              const y = Number(sp.get('y'));
              const z = Number(sp.get('z'));
              if (world && Number.isFinite(x) && Number.isFinite(z)) {
                return {
                  dimension: world,
                  x: Math.round(x),
                  y: Number.isFinite(y) ? Math.round(y) : 0,
                  z: Math.round(z),
                };
              }
            } catch (e) {}

            // 3) Fallback: explicit hash param
            try {
              const sp = new URLSearchParams(window.location.search || '');
              const rawHash = String(sp.get('hash') || '').trim();
              const h = rawHash ? rawHash.replace(/^#/, '') : '';
              if (!h) return null;
              const parts = h.split(':');
              if (!parts || parts.length < 4) return null;
              const dimension = decodeURIComponent(parts[0] || '');
              const x = Number(decodeURIComponent(parts[1] || ''));
              const y = Number(decodeURIComponent(parts[2] || ''));
              const z = Number(decodeURIComponent(parts[3] || ''));
              if (!dimension || !Number.isFinite(x) || !Number.isFinite(z)) return null;
              return {
                dimension,
                x: Math.round(x),
                y: Number.isFinite(y) ? Math.round(y) : 0,
                z: Math.round(z),
              };
            } catch (e) {
              return null;
            }
          },
          async loadShareChats() {
            if (this.shareChatsLoading) return;
            this.shareChatsLoading = true;
            this.shareError = '';
            try {
              if (!this.apiBase) await this.fetchConfig();
              if (!this.apiBase) throw new Error('缺少 API 配置');
              const res = await this.safeFetch(`${this.apiBase}/chats`);
              if (!res.ok) throw new Error('加载会话失败');
              const list = await res.json().catch(() => []);
              const arr = Array.isArray(list) ? list : [];
              this.shareChatOptions = arr
                .filter((c) => c && String(c.id || '').trim() && String(c.id) !== 'global')
                .map((c) => ({ value: String(c.id), label: String(c.displayName || c.name || c.id) }));
            } catch (e) {
              this.shareError = (e && e.message) ? e.message : String(e);
              this.shareChatOptions = [];
            } finally {
              this.shareChatsLoading = false;
            }
          },
          async openShare() {
            this.shareError = '';
            const coords = this.parseCoordsFromCurrentUrl();
            if (!coords) {
              try { ElementPlus.ElMessage.warning('当前页面没有可分享的坐标参数'); } catch (e0) {}
              return;
            }
            this.shareDialogVisible = true;
            await this.loadShareChats();
          },
          async confirmShare() {
            if (this.shareSending) return;
            try {
              this.shareError = '';
              const coords = this.parseCoordsFromCurrentUrl();
              if (!coords) {
                this.shareError = '当前页面没有可分享的坐标参数';
                return;
              }
              const name = String(this.shareForm.name || '').trim();
              const descriptionRaw = String(this.shareForm.description || '').trim();
              const description = descriptionRaw ? descriptionRaw : null;
              const chatId = String(this.shareChatId || '').trim();
              if (!chatId) {
                this.shareError = '请选择会话';
                return;
              }
              if (!name) {
                this.shareError = '请输入名称';
                return;
              }

              this.shareSending = true;
              if (!this.apiBase) await this.fetchConfig();
              if (!this.apiBase) throw new Error('缺少 API 配置');
              const payload = {
                type: 'coordinate',
                content: {
                  name,
                  dimension: coords.dimension,
                  x: coords.x,
                  y: coords.y,
                  z: coords.z,
                  description,
                },
              };
              const res = await this.safeFetch(`${this.apiBase}/chats/${encodeURIComponent(chatId)}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
              });
              if (!res.ok) {
                const txt = await res.text().catch(() => '');
                throw new Error(txt || '发送失败');
              }
              this.shareDialogVisible = false;
              this.shareChatId = '';
              this.shareForm.name = '';
              this.shareForm.description = '';
              try { ElementPlus.ElMessage.success('已发送'); } catch (e2) {}
            } catch (e) {
              this.shareError = (e && e.message) ? e.message : String(e);
            } finally {
              this.shareSending = false;
            }
          },
          goBack() {
            try {
              if (window.history && window.history.length > 1) {
                window.history.back();
                return;
              }
            } catch (e) {}
            window.location.href = '/m/me.html';
          },
        },
      });

      try {
        const icons = window.ElementPlusIconsVue;
        if (icons && typeof icons === 'object') {
          for (const [key, component] of Object.entries(icons)) {
            app.component(key, component);
          }
        }
      } catch (e) {}

      app.use(ElementPlus).mount('#app');
    </script>
  </body>
</html>
