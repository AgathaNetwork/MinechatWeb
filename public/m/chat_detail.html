<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>会话详情 - Minechat</title>
    <link rel="stylesheet" href="/styles.css" />
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <style>
      [v-cloak]{display:none}
      html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-text-size-adjust:100%}
      body{margin:0;padding:0}
      input,textarea,.el-input__inner,.el-textarea__inner{font-size:16px !important}
      .top-bar{position:fixed;top:0;left:0;right:0;height:50px;background:#fff;border-bottom:1px solid #e6e6e6;display:flex;align-items:center;padding:0 12px;z-index:100;gap:8px}
      .messages-area{position:fixed;top:50px;left:0;right:0;bottom:var(--input-area-height, 160px);overflow:auto;padding:12px;background:#f5f5f5;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;touch-action:pan-y}
      .input-area{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid #ddd;padding:10px;padding-bottom:calc(10px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:6px;touch-action:manipulation}
      .msg-row{width:100%;margin-bottom:10px;display:flex;gap:8px;align-items:flex-start}
      .msg-row.own{justify-content:flex-end}
      .msg-row.other{justify-content:flex-start}
      .msg-content-wrapper{display:flex;flex-direction:column;max-width:75%;min-width:60px;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}
      .msg-row.own .msg-content-wrapper{align-items:flex-end}
      .msg-row.other .msg-content-wrapper{align-items:flex-start}
      .msg-bubble{padding:8px 10px;border-radius:12px;word-break:break-word;width:fit-content;display:inline-block;border:1px solid #eee;color:#222;max-width:100%}
      .msg-time{font-size:11px;color:#999;text-align:center;margin-top:4px;opacity:0;transition:opacity 0.2s}
      .msg-content-wrapper.show-time .msg-time{opacity:1}
      .time-divider{display:flex;align-items:center;justify-content:center;margin:10px 0;color:#999;font-size:12px;user-select:none}
      .time-divider:before,.time-divider:after{content:'';flex:1;border-top:1px solid #e6e6e6}
      .time-divider-text{padding:0 10px;white-space:nowrap;background:#f5f5f5}
      .img-preview-mask{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:99999;padding:16px}
      .img-preview-img{max-width:95vw;max-height:95vh;object-fit:contain;border-radius:8px;background:#fff;touch-action:none;user-select:none;transform-origin:0 0}
      .ctx-menu{position:fixed;z-index:9999;background:#fff;border:1px solid #dcdfe6;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.1);min-width:140px;overflow:hidden}
      .ctx-menu-item{padding:12px 16px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:15px}
      .ctx-menu-item:last-child{border-bottom:none}
      .ctx-menu-item:active{background:#f5f5f5}
      .loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #409eff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
      @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    </style>
  </head>
  <body>
    <div id="app" v-cloak>
      <div class="top-bar">
        <el-button @click="goBack" size="small" style="padding:5px 10px">
          <el-icon><arrow-left /></el-icon>
        </el-button>
        <el-avatar v-if="currentChatFaceUrl" shape="square" :src="currentChatFaceUrl" :size="32"></el-avatar>
        <h3 style="margin:0;flex:1">{{ currentChatTitle }}</h3>
        <el-button v-if="isGroupChat" @click="openGroupManage" circle size="small" style="flex-shrink:0" title="群聊管理">
          <el-icon><more-filled /></el-icon>
        </el-button>
      </div>

      <div class="messages-area" ref="messagesEl" @scroll="onMessagesScroll">
        <div v-if="imagePreviewVisible" class="img-preview-mask" @click="requestCloseImagePreview" @touchstart="onMaskTouchStart" @touchmove="onMaskTouchMove" @touchend="onMaskTouchEnd" @touchcancel="onMaskTouchEnd">
          <img
            :src="imagePreviewUrl"
            class="img-preview-img"
            :style="imagePreviewStyle"
            @click.stop="requestCloseImagePreview"
            @touchstart.stop.prevent="onImagePreviewTouchStart"
            @touchmove.stop.prevent="onImagePreviewTouchMove"
            @touchend.stop="onImagePreviewTouchEnd"
            @touchcancel.stop="onImagePreviewTouchEnd"
          />
        </div>
        <div v-if="chatLoading" style="display:flex;align-items:center;justify-content:center;padding:40px">
          <div style="text-align:center">
            <div class="loading-spinner"></div>
            <div style="margin-top:12px;color:#666;font-size:14px">加载中...</div>
          </div>
        </div>

        <div v-if="loadingMore" style="display:flex;justify-content:center;padding:6px 0">
          <div class="loading-spinner" style="width:22px;height:22px;border-width:3px"></div>
        </div>

        <template v-for="(m, idx) in messages" :key="m.id">
          <div v-if="shouldShowTimeDivider(idx)" class="time-divider">
            <span class="time-divider-text">{{ formatTime(m) }}</span>
          </div>

          <div class="msg-wrapper" :data-id="m.id" :class="['msg-row', isOwnMessage(m) ? 'own' : 'other']">
          <el-avatar v-if="!isOwnMessage(m) && messageAuthorFaceUrl(m)" shape="square" :src="messageAuthorFaceUrl(m)" :size="36" style="flex-shrink:0"></el-avatar>
          <div :class="['msg-content-wrapper', m.__showTime ? 'show-time' : '']" @click="toggleMessageTime(m)" @touchstart="onTouchStart(m, $event)" @touchend="onTouchEnd" @touchmove="onTouchMove">
            <div style="font-size:11px;color:#888;margin-bottom:2px;padding:0 4px">{{ messageAuthorName(m) }}</div>

            <div v-if="!isGlobalChat && m.replied_to && repliedRefMessage(m)" class="reply-quote"
                 style="padding:6px 8px;border-left:3px solid #ccc;background:#f7f7f7;margin:0 0 6px 0;border-radius:6px;width:100%">
              <span style="cursor:pointer" @click.stop="scrollToMessage((typeof m.replied_to==='object') ? (m.replied_to.id||'') : m.replied_to)">
                {{ messageAuthorName(repliedRefMessage(m)) }}:
                <template v-if="messagePreviewTag(repliedRefMessage(m))">
                  <el-tag type="info" effect="plain" size="small">{{ messagePreviewTag(repliedRefMessage(m)) }}</el-tag>
                  <span v-if="messagePreviewSuffix(repliedRefMessage(m))" style="margin-left:6px;color:#666">{{ messagePreviewSuffix(repliedRefMessage(m)) }}</span>
                </template>
                <template v-else>
                  {{ messagePreviewText(repliedRefMessage(m)) || '已回复' }}
                </template>
              </span>
            </div>

            <div class="msg-bubble" :style="{ background: bubbleBackground(m) }">
              <template v-if="isRecalledMessage(m)">
                <el-tag type="info" effect="plain" size="small">{{ recallNoticeText(m) }}</el-tag>
              </template>
              <template v-else-if="m.type==='emoji' && m.content && m.content.url">
                <img :src="m.content.url" alt="emoji" style="max-height:96px;display:block;cursor:pointer" @click.stop="openImagePreview(m.content.url)" />
              </template>
              <template v-else-if="m.type==='file' && m.content && isImageFile(m)">
                <img :src="fileDisplayUrl(m)" :alt="m.content.filename || 'image'" style="max-width:100%;max-height:200px;display:block;border-radius:6px;cursor:pointer" @click.stop="openImagePreview(fileDisplayUrl(m))" />
              </template>
              <template v-else-if="m.type==='file' && m.content && isVideoFile(m)">
                <video :src="fileDisplayUrl(m)" controls style="max-width:100%;max-height:240px;display:block;border-radius:8px"></video>
                <div v-if="m.content.filename" style="margin-top:6px;font-size:12px;color:#666">{{ m.content.filename }}</div>
              </template>
              <template v-else-if="m.type==='file' && m.content && (m.content.url || m.content.__localUrl)">
                <a :href="fileDisplayUrl(m)" target="_blank" rel="noopener" style="color:#0366d6;text-decoration:none">
                  {{ m.content.filename || '下载文件' }}
                </a>
              </template>
              <template v-else>
                <span style="white-space:pre-wrap">{{ messageTextPreview(m) }}</span>
              </template>
            </div>
            <div class="msg-time">{{ formatTime(m) }}</div>
          </div>
          </div>
        </template>
      </div>

      <div v-if="ctxMenuVisible" class="ctx-menu" :style="{ left: ctxMenuX + 'px', top: ctxMenuY + 'px' }" @click.stop>
        <div class="ctx-menu-item" @click="ctxReply">回复</div>
        <div v-if="canRecallMessage(ctxMenuMsg)" class="ctx-menu-item" @click="ctxRecall">撤回</div>
        <div v-if="canCollectEmoji(ctxMenuMsg)" class="ctx-menu-item" @click="ctxCollectEmoji">添加到表情包</div>
      </div>

      <div class="input-area" ref="inputAreaEl">
        <div v-if="replyTarget" style="padding:6px 8px;background:#f7f7f7;border-radius:6px;font-size:12px;display:flex;justify-content:space-between;align-items:center;border-left:3px solid #ccc">
          <span>
            回复:
            <template v-if="messagePreviewTag(replyTarget)">
              <el-tag type="info" effect="plain" size="small">{{ messagePreviewTag(replyTarget) }}</el-tag>
              <span v-if="messagePreviewSuffix(replyTarget)" style="margin-left:6px;color:#666">{{ messagePreviewSuffix(replyTarget) }}</span>
            </template>
            <template v-else>
              {{ messagePreviewText(replyTarget) || '消息' }}
            </template>
          </span>
          <el-button size="small" @click="clearReplyTarget">取消</el-button>
        </div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <input ref="fileInputEl" type="file" accept="image/*,video/*" style="display:none" @change="onFileSelected" />
          <div v-if="!isGlobalChat" style="display:flex;gap:2px;align-items:center;flex-shrink:0">
            <el-button @click="openFilePicker" circle style="flex-shrink:0">
              <el-icon><folder-opened /></el-icon>
            </el-button>
            <el-button @click="toggleEmojiPanel" circle style="flex-shrink:0">
              <el-icon><magic-stick /></el-icon>
            </el-button>
          </div>
          <el-input v-model="msgInput" placeholder="输入消息" @keyup.enter="sendText" style="flex:1"></el-input>
          <el-button type="primary" @click="sendText" style="flex-shrink:0">发送</el-button>
        </div>

        <div v-if="emojiPanelVisible" style="max-height:200px;overflow:auto;background:#fff;border:1px solid #ddd;padding:8px;border-radius:6px;margin-top:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>我的表情包</strong>
            <el-button size="small" @click="goEmojiManage">管理</el-button>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px">
            <button v-for="p in emojiPacks" :key="p.id" @click="sendEmoji(p)" style="border:none;background:transparent;padding:4px;cursor:pointer">
              <img :src="p.url" alt="emoji" style="width:48px;height:48px;object-fit:contain" />
            </button>
          </div>
        </div>
      </div>

      <el-drawer v-model="groupManageVisible" title="群聊管理" direction="btt" size="70%">
        <div v-if="groupManageLoading" style="padding:16px">
          <el-skeleton animated :rows="5" />
        </div>
        <div v-else style="padding:0 4px">
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <el-input v-model="groupEditName" placeholder="群聊名称" style="flex:1;min-width:180px"></el-input>
            <el-button type="primary" size="small" :loading="groupActionLoading" :disabled="!groupCanManage" @click="saveGroupName">保存</el-button>
          </div>
          <div v-if="!groupCanManage" style="margin-top:6px;font-size:12px;color:#888">无权限修改</div>

          <div style="margin-top:16px">
            <div style="font-weight:600;margin-bottom:8px">邀请成员</div>
            <el-select v-model="inviteSelected" multiple filterable placeholder="选择要邀请的玩家" style="width:100%">
              <el-option v-for="u in inviteOptions" :key="u.id" :label="u.label" :value="u.id" />
            </el-select>
            <div style="margin-top:10px;display:flex;justify-content:flex-end">
              <el-button type="primary" size="small" :loading="groupActionLoading" :disabled="!groupCanManage || inviteSelected.length===0" @click="inviteToGroup">邀请</el-button>
            </div>
          </div>

          <div style="margin-top:16px">
            <div style="font-weight:600;margin-bottom:8px">成员</div>
            <div style="max-height:260px;overflow:auto;border:1px solid #eee;border-radius:8px;background:#fff">
              <div v-for="mid in groupMembers" :key="mid" style="display:flex;align-items:center;justify-content:space-between;padding:10px 10px;border-bottom:1px solid #f3f3f3">
                <div style="min-width:0">
                  <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                    <span style="font-weight:500">{{ userLabel(mid) }}</span>
                    <el-tag v-if="String(mid)===String(groupOwnerId)" type="info" effect="plain" size="small">群主</el-tag>
                    <el-tag v-else-if="groupAdmins.includes(String(mid))" type="info" effect="plain" size="small">管理员</el-tag>
                  </div>
                  <div style="font-size:12px;color:#888">{{ mid }}</div>
                </div>
                <el-button
                  v-if="groupCanManage && String(mid)!==String(groupOwnerId) && String(mid)!==String(selfUserId)"
                  size="small"
                  type="danger"
                  plain
                  :loading="groupActionLoading"
                  @click="kickFromGroup(mid)"
                >移除</el-button>
              </div>
            </div>
          </div>

          <div v-if="groupIsOwner" style="margin-top:16px">
            <div style="font-weight:600;margin-bottom:8px">管理员</div>
            <el-select v-model="adminSelected" multiple filterable placeholder="选择管理员（不包含群主）" style="width:100%">
              <el-option v-for="u in adminOptions" :key="u.id" :label="u.label" :value="u.id" />
            </el-select>
            <div style="margin-top:10px;display:flex;justify-content:flex-end">
              <el-button type="primary" size="small" :loading="groupActionLoading" @click="saveGroupAdmins">保存管理员</el-button>
            </div>
          </div>

          <div v-if="groupIsOwner" style="margin-top:16px">
            <div style="font-weight:600;margin-bottom:8px">转让群主</div>
            <el-select v-model="transferOwnerId" filterable placeholder="选择新群主" style="width:100%">
              <el-option v-for="u in transferOptions" :key="u.id" :label="u.label" :value="u.id" />
            </el-select>
            <div style="margin-top:10px;display:flex;justify-content:flex-end">
              <el-button type="warning" size="small" :loading="groupActionLoading" :disabled="!transferOwnerId" @click="transferGroupOwner">转让</el-button>
            </div>
          </div>
        </div>
      </el-drawer>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue@2/dist/index.iife.min.js"></script>
    <script src="/api/socket.io/socket.io.js"></script>
    <script src="/m/chat_detail.js"></script>
    <script>
      // Disable pinch-zoom on iOS Safari
      document.addEventListener('gesturestart', function (e) { e.preventDefault(); }, { passive: false });
      document.addEventListener('gesturechange', function (e) { e.preventDefault(); }, { passive: false });
      document.addEventListener('gestureend', function (e) { e.preventDefault(); }, { passive: false });

      // Some WebViews still change zoom on input focus; force restore to 1x.
      (function () {
        var meta = document.querySelector('meta[name="viewport"]');
        if (!meta) return;
        var canonical = 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover';
        function restoreViewport() {
          try {
            meta.setAttribute('content', canonical);
          } catch (e) {}
        }
        function onPossibleZoomChange() {
          restoreViewport();
          setTimeout(restoreViewport, 50);
          setTimeout(restoreViewport, 250);
        }
        document.addEventListener('focusin', function (e) {
          var t = e && e.target;
          if (!t) return;
          var tag = (t.tagName || '').toUpperCase();
          if (tag === 'INPUT' || tag === 'TEXTAREA') onPossibleZoomChange();
        }, true);
        document.addEventListener('focusout', function () { onPossibleZoomChange(); }, true);
        window.addEventListener('resize', onPossibleZoomChange);
        window.addEventListener('orientationchange', onPossibleZoomChange);
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', onPossibleZoomChange);
        }
      })();
    </script>
  </body>
</html>
